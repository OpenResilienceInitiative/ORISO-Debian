apiVersion: v1
items:
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    labels:
      app: matrix-synapse
    name: matrix-synapse
    namespace: caritas
  spec:
    progressDeadlineSeconds: 600
    replicas: 1
    revisionHistoryLimit: 10
    selector:
      matchLabels:
        app: matrix-synapse
    strategy:
      rollingUpdate:
        maxSurge: 25%
        maxUnavailable: 25%
      type: RollingUpdate
    template:
      metadata:
        labels:
          app: matrix-synapse
      spec:
        initContainers:
        - name: fix-permissions
          image: busybox:latest
          command:
          - sh
          - -c
          - |
            chown -R 991:991 /data || true
            chmod -R u+w /data || true
          securityContext:
            runAsUser: 0
          volumeMounts:
          - name: synapse-data
            mountPath: /data
        containers:
        - env:
          - name: SYNAPSE_SERVER_NAME
            value: "caritas.local"
          - name: SYNAPSE_REPORT_STATS
            value: 'no'
          - name: SYNAPSE_ENABLE_AUTHENTICATED_MEDIA
            value: 'false'
          image: matrixdotorg/synapse:latest
          imagePullPolicy: Always
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /_matrix/client/versions
              port: 8008
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 1
          name: synapse
          ports:
          - containerPort: 8008
            protocol: TCP
          - containerPort: 8009
            protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /_matrix/client/versions
              port: 8008
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              cpu: '3'
              memory: 6Gi
            requests:
              cpu: 1500m
              memory: 3Gi
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /data
            name: synapse-data
          - mountPath: /data/homeserver.yaml
            name: homeserver-config
            subPath: homeserver.yaml
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext:
          fsGroup: 991
          runAsUser: 991
          runAsGroup: 991
        terminationGracePeriodSeconds: 30
        volumes:
        - name: synapse-data
          persistentVolumeClaim:
            claimName: matrix-synapse-data
        - configMap:
            defaultMode: 420
            name: matrix-homeserver-oidc
          name: homeserver-config
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: element
    namespace: caritas
  spec:
    progressDeadlineSeconds: 600
    replicas: 1
    revisionHistoryLimit: 1
    selector:
      matchLabels:
        app: element
    strategy:
      rollingUpdate:
        maxSurge: 25%
        maxUnavailable: 25%
      type: RollingUpdate
    template:
      metadata:
        labels:
          app: element
      spec:
        containers:
        - image: oriso-element:latest
          imagePullPolicy: Never
          name: element
          ports:
          - containerPort: 8087
            protocol: TCP
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
        dnsPolicy: ClusterFirst
        hostNetwork: true
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext: {}
        terminationGracePeriodSeconds: 30
        volumes: []

